# @mark/database

PostgreSQL database adapter for Mark using dbmate migrations and zapatos type generation.

> **Note**: This is a Yarn workspace package. All commands should be run from the repository root using `yarn workspace @mark/database <command>`.

## Overview

This package provides a type-safe PostgreSQL database adapter with:

- **dbmate** for database migrations
- **zapatos** for TypeScript type generation
- **Connection pooling** with retry logic and health checks
- **Transaction support** for atomic operations
- **Docker Compose** setup for local development

## Quick Start

```bash
# From the repository root:

# Setup database (starts Docker, runs migrations, generates types)
yarn workspace @mark/database db:setup

# Or manually run individual steps
yarn workspace @mark/database db:migrate      # Run migrations
yarn workspace @mark/database db:types       # Generate TypeScript types
```

```typescript
import {
  initializeDatabase,
  connectWithRetry,
  createEarmark,
  getEarmarks
} from '@mark/database';

// Initialize with retry logic
const pool = await connectWithRetry({
  connectionString: process.env.DATABASE_URL,
  maxConnections: 20
});

// Create an earmark
const newEarmark = await createEarmark({
  invoiceId: 'inv-123',
  designatedPurchaseChain: 1,
  tickerHash: '0x1234567890123456789012345678901234567890',
  minAmount: '100000000000'
});

// Query earmarks
const pendingEarmarks = await getEarmarks({ status: 'pending' });
```

## Development Workflow

### Database Setup

The `yarn workspace @mark/database db:setup` command starts a PostgreSQL 15 instance with Docker on port 5433:
- Database: `mark_dev`
- User: `postgres`
- Password: `postgres`

To manage the database container manually:
```bash
docker compose up -d    # Start container
docker compose stop     # Stop container
docker compose down -v  # Remove container and volumes
```

### Migrations

```bash
# Create new migration
yarn workspace @mark/database db:new add_feature_name

# Apply migrations
yarn workspace @mark/database db:migrate

# Check status
yarn workspace @mark/database db:status

# Rollback last migration
yarn workspace @mark/database db:rollback
```

### Type Generation

```bash
# Regenerate types after schema changes
yarn workspace @mark/database db:types

# Build package
yarn workspace @mark/database build
```

### Testing

```bash
# Run tests (from repository root)
yarn workspace @mark/database test        # Run all tests (auto-creates test DB)
yarn workspace @mark/database lint        # Run linting
```

#### Test Structure

- **`test/unit.spec.ts`** - Mocked unit tests
  - Connection management
  - Health checks and retry logic
  - Type definitions and error classes
  - No real database required

- **`test/integration.spec.ts`** - Local database integration tests
  - CRUD operations for earmarks
  - Transaction safety
  - Database constraints
  - Requires PostgreSQL container running

- **`test/setup.ts`** - Shared test utilities
  - Global Jest setup (auto-creates test DB)
  - Mock factories for unit tests
  - Database cleanup utilities

The test database is automatically created and migrated when you run tests for the first time.

## Database Schema

Three main tables for earmark tracking:

- **earmarks** - Invoice earmarks awaiting rebalancing
  - States:
    - `pending` - All rebalancing ops submitted
    - `ready` - Funds are ready (all rebalancing ops completed)
    - `completed` - Invoice purchased
    - `cancelled` - Earmark cancelled before completion
- **rebalance_operations** - Individual rebalancing operations
  - States:
    - `pending` - Operation submitted
    - `awaiting_callback` - Callback needed
    - `completed` - Rebalancing completed
    - `expired` - Rebalancing op expired after 24 hrs

See migration files in `db/migrations/` for full schema.

## API Reference

### Connection Management
- `initializeDatabase(config)` - Initialize connection pool
- `connectWithRetry(config, maxRetries?, delayMs?)` - Connect with retry logic
- `closeDatabase()` - Close connections gracefully
- `checkDatabaseHealth()` - Health check with latency

### Earmark Operations
- `createEarmark(input)` - Create a new earmark
- `getEarmarks(filter?)` - Query earmarks with optional filters
- `getEarmarkForInvoice(invoiceId)` - Get earmark for specific invoice
- `updateEarmarkStatus(id, status)` - Update earmark status
- `getActiveEarmarksForChain(chainId)` - Get pending earmarks for a chain
- `withTransaction(callback)` - Execute operations in transaction

### Types
All database types are auto-generated by zapatos from schema:
```typescript
import type { earmarks, earmarks_insert, rebalance_operations } from '@mark/database';
```

## Environment Variables

No environment variables are required for local development. The database connections are configured automatically:
- Development: `postgresql://postgres:postgres@localhost:5433/mark_dev`
- Test: `postgresql://postgres:postgres@localhost:5433/mark_test`

For production or custom setups, you can override with `DATABASE_URL`.

## Troubleshooting

**Database connection issues:**
- Ensure Docker is running: `docker ps | grep mark-database`
- Check if using correct port (5433, not 5432)
- Use `yarn workspace @mark/database db:status` to verify migrations

**Type generation fails:**
- Run `yarn db:migrate` first
- Check database connectivity
- Verify `zapatosconfig.json` settings

# @mark/database

PostgreSQL database adapter for Mark using dbmate migrations and zapatos type generation.

## Overview

This package provides a type-safe PostgreSQL database adapter with:

- **dbmate** for database migrations
- **zapatos** for TypeScript type generation
- **Connection pooling** with retry logic and health checks
- **Transaction support** for atomic operations

## Quick Start

```bash
# Setup database
DATABASE_URL=postgresql://localhost:5432/mark_dev yarn db:create
DATABASE_URL=postgresql://localhost:5432/mark_dev yarn db:migrate
DATABASE_URL=postgresql://localhost:5432/mark_dev yarn db:generate-types
```

```typescript
import { initializeDatabase, db, connectWithRetry } from '@mark/database';

// Initialize with retry logic
const pool = await connectWithRetry({
  connectionString: process.env.DATABASE_URL,
  maxConnections: 20
});

// Use typed operations
const earmarks = await db.earmarks.select({ status: 'pending' });
const newEarmark = await db.earmarks.insert({
  invoiceId: 'inv-123',
  destinationChainId: 1,
  ticker: 'USDC',
  invoiceAmount: '100.50'
});
```

## Development Workflow

### Migrations

```bash
# Create new migration
yarn db:new add_feature_name

# Apply migrations
yarn db:migrate

# Check status
yarn db:status

# Rollback last migration
yarn db:rollback
```

### Type Generation

```bash
# Regenerate types after schema changes
yarn db:generate-types

# Build package
yarn build
```

### Testing

```bash
yarn test        # Run all tests
yarn lint        # Run linting
```

## Database Schema

Three main tables for earmark tracking:

- **earmarks** - Invoice earmarks awaiting rebalancing
- **rebalance_operations** - Individual rebalancing operations
- **earmark_audit_log** - Complete audit trail

See migration files in `db/migrations/` for full schema.

## API Reference

### Connection Management
- `initializeDatabase(config)` - Initialize connection pool
- `connectWithRetry(config, maxRetries?, delayMs?)` - Connect with retry logic
- `closeDatabase()` - Close connections gracefully
- `checkDatabaseHealth()` - Health check with latency

### Database Operations
- `db.earmarks` - CRUD operations for earmarks table
- `db.rebalance_operations` - CRUD operations for rebalance operations
- `db.earmark_audit_log` - CRUD operations for audit log
- `withTransaction(callback)` - Execute operations in transaction

### Types
All database types are auto-generated by zapatos from schema:
```typescript
import type { earmarks, earmarks_insert, rebalance_operations } from '@mark/database';
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `DATABASE_URL` | Yes | PostgreSQL connection string |

## Troubleshooting

**Database connection issues:**
- Ensure PostgreSQL is running
- Check `DATABASE_URL` format: `postgresql://user:pass@localhost:5432/dbname`
- Use `yarn db:status` to verify migrations

**Type generation fails:**
- Run `yarn db:migrate` first
- Check database connectivity
- Verify `zapatosconfig.json` settings
